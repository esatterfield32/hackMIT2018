<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<!-- the above Mark of the Web lets IE run this page in the Internet security zone,
     avoiding the permission prompt for running active content such as JavaScript -->
<html>
<head>
    <meta charset="UTF-8">
    <title>Bing News Search API Demo</title>
    <base target="_blank">
    <script type="text/javascript">

        var searchResultJson;
        // cookie names for data we store
        // YOUR API KEY DOES NOT GO IN THIS CODE; don't paste it in.
        API_KEY_COOKIE   = "bing-search-api-key";
        CLIENT_ID_COOKIE = "bing-search-client-id";

        // Bing Search API endpoint
        BING_ENDPOINT = "https://api.cognitive.microsoft.com/bing/v7.0/news";

        // Various browsers differ in their support for persistent storage by local
        // HTML files (IE won't use localStorage, but Chrome won't use cookies). So
        // use localStorage if we can, otherwise use cookies.

        try {
            localStorage.getItem;   // try localStorage

            window.retrieveValue = function (name) {
                return localStorage.getItem(name) || "";
            }
            window.storeValue = function(name, value) {
                localStorage.setItem(name, value);
            }
        } catch (e) {
            window.retrieveValue = function (name) {
                var cookies = document.cookie.split(";");
                for (var i = 0; i < cookies.length; i++) {
                    var keyvalue = cookies[i].split("=");
                    if (keyvalue[0].trim() === name) return keyvalue[1];
                }
                return "";
            }
            window.storeValue = function (name, value) {
                var expiry = new Date();
                expiry.setFullYear(expiry.getFullYear() + 1);
                document.cookie = name + "=" + value.trim() + "; expires=" + expiry.toUTCString();
            }
        }

        // get stored API subscription key, or prompt if it's not found
        function getSubscriptionKey() {
            return "a5cd4485d1954425990f91afb710716f";
        }

        // invalidate stored API subscription key so user will be prompted again
        function invalidateSubscriptionKey() {
            storeValue(API_KEY_COOKIE, "");
        }


        function renderErrorMessage(message) {
            showDiv("error", preFormat(message));
            showDiv("noresults", "No results.");
        }

        // handle Bing search request results
        function handleBingResponse() {
            document.getElementById("debug").innerHTML = "handleBingResponse 1";

            var json = this.responseText.trim();
            var jsobj = {};

            // try to parse JSON results
            try {
                if (json.length) jsobj = JSON.parse(json);

            } catch(e) {
                renderErrorMessage("Invalid JSON response");
            }



            // if HTTP response is 200 OK, try to render search results
            if (this.status === 200) {
                var clientid = this.getResponseHeader("X-MSEdge-ClientID");
                if (clientid) retrieveValue(CLIENT_ID_COOKIE, clientid);
                if (json.length) {
                    if (jsobj._type === "News") {
                        //renderSearchResults(jsobj);
                        searchResultJson = jsobj;
                        document.getElementById("debug").innerHTML = searchResultJson.value[0].description + "\n\n";
                    } else {
                        renderErrorMessage("No search results in JSON response");
                    }
                } else {
                    renderErrorMessage("Empty response (are you sending too many requests too quickly?)");
                }
            }

            // Any other HTTP response is an error
            else {
                // 401 is unauthorized; force re-prompt for API key for next request
                if (this.status === 401) invalidateSubscriptionKey();

                // some error responses don't have a top-level errors object, so gin one up
                var errors = jsobj.errors || [jsobj];
                var errmsg = [];

                // display HTTP status code
                errmsg.push("HTTP Status " + this.status + " " + this.statusText + "\n");

                // add all fields from all error responses
                for (var i = 0; i < errors.length; i++) {
                    if (i) errmsg.push("\n");
                    for (var k in errors[i]) errmsg.push(k + ": " + errors[i][k]);
                }

                // also display Bing Trace ID if it isn't blocked by CORS
                var traceid = this.getResponseHeader("BingAPIs-TraceId");
                if (traceid) errmsg.push("\nTrace ID " + traceid);

                // and display the error message
                renderErrorMessage(errmsg.join("\n"));
            }
        }

        // perform a search given query, options string, and API key
        function bingNewsSearch(query, options, key) {

            // scroll to top of window
            window.scrollTo(0, 0);
            //if (!query.trim().length) return false;     // empty query, do nothing

            var request = new XMLHttpRequest();
            if (category.valueOf() != "all".valueOf()) {
                var queryurl = BING_ENDPOINT + "?" + options;
            }
            else {
                if (query){
                    var queryurl = BING_ENDPOINT + "/search" + "?q=" + encodeURIComponent(query) + "&" + options;
                }
                else {
                    var queryurl = BING_ENDPOINT + "?" + options;
                }
            }

            // open the request
            try {
                request.open("GET", queryurl);
            }
            catch (e) {
                renderErrorMessage("Bad request (invalid URL)\n" + queryurl);
                return false;
            }

            // add request headers
            request.setRequestHeader("Ocp-Apim-Subscription-Key", key);
            request.setRequestHeader("Accept", "application/json");

            var clientid = retrieveValue(CLIENT_ID_COOKIE);
            if (clientid) request.setRequestHeader("X-MSEdge-ClientID", clientid);

            // event handler for successful response
            request.addEventListener("load", handleBingResponse);

            // event handler for erorrs
            request.addEventListener("error", function() {
                renderErrorMessage("Error completing request");
            });

            // event handler for aborted request
            request.addEventListener("abort", function() {
                renderErrorMessage("Request aborted");
            });

            // send the request
            request.send();
            return false;
        }

        // build query options from the HTML form
        function bingSearchOptions() {

            var options = [];
            options.push("mkt=" + "en-US");
            options.push("SafeSearch=" + "off");
            options.push("freshness=" + "");


            category = "all"
            if (category.valueOf() != "all".valueOf()){
                options.push("category=" + category);
            }

            //options.push("category=" + category);

            options.push("count=" + "25");
            options.push("offset=" + "0");
            return options.join("&");
        }


        function newBingNewsSearch() {
            return bingNewsSearch("potato", bingSearchOptions(), getSubscriptionKey());
        }

        //final use case
        function searchTheNews(query){
            return bingNewsSearch(query, bingSearchOptions(), getSubscriptionKey());
        }

        function getTheNews(){
            document.getElementById("debug2").innerHTML = searchResultJson.value[0].description + "\n\n";
            document.getElementById("debug3").innerHTML = searchResultJson.value[1].description + "\n\n";
            document.getElementById("debug4").innerHTML = searchResultJson.value[2].description + "\n\n";
            document.getElementById("debug5").innerHTML = searchResultJson.value[3].description + "\n\n";
            return searchResultJson;
        }

        // --></script>



</head>
<body onload="document.forms.bing.query.focus();">

<p id="debug">
    hello world
</p>
<p id="debug2">
    hello world2
</p>

<p id="debug3">
    hello world3
</p>

<p id="debug4">
    hello world4
</p>

<p id="debug5">
    hello world4
</p>



<button onclick="searchTheNews('mexicans are taking our jobs')">Click me</button>

<button onclick="getTheNews()">Click me2</button>



</body>
</html>